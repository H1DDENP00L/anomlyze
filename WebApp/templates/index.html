<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chii2 Model Interface</title>
    <style>
      /* Стили без изменений */
      body { font-family: sans-serif; margin: 20px; }
      .container { display: flex; gap: 20px; }
      .controls { width: 30%; }
      .video-area { width: 70%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
      img { max-width: 100%; max-height: 70vh; border: 1px solid #ccc; display: block; margin: 0 auto; }
      pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; white-space: pre-wrap; word-break: break-all; } /* Добавил перенос строк в pre */
    </style>
</head>
<body>
    <h1>Chii2 - Human Activity Recognition</h1>
    <div class="container">
        <div class="controls">
            <h2>Control Panel</h2>
            <form id="start-form">
                <p>
                    <label for="file">Upload Video (MP4, AVI, MOV, MKV):</label><br>
                    <input type="file" name="file" id="file" accept=".mp4,.avi,.mov,.mkv">
                </p>
                <p>OR</p>
                <p>
                    <label for="rtsp_url">Enter RTSP URL:</label><br>
                    <input type="text" name="rtsp_url" id="rtsp_url" size="30">
                </p>
                <!-- Кнопка Start: начальное состояние определяется сервером -->
                <input id="start-button" type="submit" value="Start Processing" {% if processing_state.is_running %}disabled{% endif %}>
            </form>
            <hr>
            <form id="stop-form" action="{{ url_for('stop_processing') }}" method="post">
                 <!-- Кнопка Stop: начальное состояние определяется сервером -->
                <input id="stop-button" type="submit" value="Stop Processing" {% if not processing_state.is_running %}disabled{% endif %}>
            </form>
            <hr>
            <h2>Status</h2>
            <pre id="status-info">Loading status...</pre>
        </div>
        <!-- Область видео: начальное состояние определяется сервером -->
        <div class="video-area">
             <h2>Processed Video Stream</h2>
            {% if processing_state.is_running %}
                <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Video Stream">
            {% else %}
                <p>No video processing active. Upload a video or enter RTSP URL to start.</p>
                 {% if processing_state.error %}
                    <p style="color: red;">Error during last processing: {{ processing_state.error }}</p>
                 {% endif %}
            {% endif %}
        </div>
    </div>

    <script>
        // --- Определяем функцию fetchStatus ВНЕ DOMContentLoaded, чтобы она была доступна ---
        function fetchStatus() {
            // Получаем элементы ВНУТРИ функции, так как они могут быть пересозданы
            const startButton = document.getElementById('start-button');
            const stopButton = document.getElementById('stop-button');
            const statusInfo = document.getElementById('status-info');
            const videoArea = document.querySelector(".video-area");
            let videoStream = document.getElementById("video-stream");

            // Проверяем, что элементы найдены (на случай ошибок рендеринга)
            if (!startButton || !stopButton || !statusInfo || !videoArea) {
                console.error("Required elements not found in fetchStatus");
                return;
            }

            fetch("{{ url_for('get_status') }}")
                .then(response => {
                    if (!response.ok) { // Проверяем статус ответа
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                 })
                .then(data => {
                    statusInfo.textContent = JSON.stringify(data, null, 2);

                    if (data.is_running) {
                        startButton.disabled = true;
                        stopButton.disabled = false;
                        stopButton.value = 'Stop Processing'; // Возвращаем текст кнопки стоп

                        if (!videoStream) {
                            videoArea.innerHTML = "<h2>Processed Video Stream</h2>";
                            const newImg = document.createElement("img");
                            newImg.id = "video-stream";
                            newImg.src = "{{ url_for('video_feed') }}";
                            newImg.alt = "Video Stream";
                            // Добавляем обработчик ошибок для img, если стрим не запустится
                            newImg.onerror = () => {
                                console.error("Failed to load video stream source.");
                                videoArea.innerHTML += '<p style="color: orange;">Failed to load video stream. Check server logs.</p>';
                                newImg.remove(); // Убираем битый img
                                // Можно попробовать обновить статус еще раз через некоторое время
                                setTimeout(fetchStatus, 2000);
                            };
                            videoArea.appendChild(newImg);
                            console.log("Stream should start, img tag added.");
                        } else {
                            // Проверим, не изменился ли src (маловероятно, но все же)
                            const expectedSrc = new URL("{{ url_for('video_feed') }}", window.location.origin).href;
                            if (videoStream.src !== expectedSrc) {
                                console.log("Correcting video stream src");
                                videoStream.src = expectedSrc;
                            }
                        }
                    } else { // Обработка не идет
                        startButton.disabled = false;
                         startButton.value = 'Start Processing'; // Возвращаем текст кнопки старт
                        stopButton.disabled = true;
                         stopButton.value = 'Stop Processing'; // Возвращаем текст кнопки стоп

                        if (videoStream) {
                            videoStream.remove();
                            console.log("Processing stopped, img tag removed.");
                        }

                        let messageHtml = "<p>No video processing active. Upload a video or enter RTSP URL to start.</p>";
                        if (data.error) {
                            messageHtml += `<p style="color: red;">Error during last processing: ${data.error}</p>`;
                        }
                        // Обновляем содержимое videoArea, только если оно отличается
                        const currentMessages = videoArea.querySelectorAll('p');
                        let currentMessageText = Array.from(currentMessages).map(p => p.outerHTML).join('');
                        let requiredHtml = "<h2>Processed Video Stream</h2>" + messageHtml;
                        if (videoArea.innerHTML !== requiredHtml) {
                             videoArea.innerHTML = requiredHtml;
                        }
                    }
                })
                .catch(error => {
                    console.error("Error fetching status:", error);
                    statusInfo.textContent = `Error fetching status: ${error.message}`;
                    // Блокируем кнопки при ошибке связи с сервером
                     if(startButton) startButton.disabled = true;
                     if(stopButton) stopButton.disabled = true;
                     // Убираем видео, если была ошибка
                     videoStream = document.getElementById("video-stream");
                     if (videoStream) videoStream.remove();
                     if (videoArea) videoArea.innerHTML = '<h2>Processed Video Stream</h2><p style="color:red;">Connection error. Cannot fetch status.</p>';

                });
        }

        // --- Весь код инициализации теперь внутри ОДНОГО DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Получаем элементы один раз при загрузке
            const startForm = document.getElementById('start-form');
            const stopForm = document.getElementById('stop-form');
            const startButton = document.getElementById('start-button');
            const stopButton = document.getElementById('stop-button');
            const fileInput = document.getElementById('file');
            const rtspInput = document.getElementById('rtsp_url');

            // --- Обработчик формы СТАРТ ---
            if (startForm && startButton && stopButton && fileInput && rtspInput) { // Добавил проверки
                startForm.addEventListener('submit', function(event) {
                    event.preventDefault();

                    const file = fileInput.files[0];
                    const rtspUrl = rtspInput.value.trim();

                    if (!file && !rtspUrl) { /* ... alert ... */ return; }
                    if (file && rtspUrl) { /* ... alert ... */ return; }

                    startButton.disabled = true;
                    startButton.value = 'Starting...';
                    stopButton.disabled = true;

                    let url = '';
                    let options = {};

                    if (file) {
                        url = "{{ url_for('upload_video') }}";
                        const formData = new FormData();
                        formData.append('file', file);
                        options = { method: 'POST', body: formData };
                    } else {
                        url = "{{ url_for('start_rtsp') }}";
                        options = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ rtsp_url: rtspUrl })
                        };
                    }

                    fetch(url, options)
                    .then(response => {
                        if (!response.ok) {
                             return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                        }
                         return response.json();
                    })
                    .then(data => {
                        console.log('Start response:', data);
                        // Сразу вызываем fetchStatus после успешного старта
                        fetchStatus();
                    })
                    .catch(error => {
                        console.error('Error starting processing:', error);
                        alert(`Error starting processing: ${error.message}`);
                         // Вызываем fetchStatus, чтобы он обновил кнопки до неактивного состояния
                        fetchStatus();
                    })
                    // .finally(() => { // Убрал finally, т.к. fetchStatus сам обновит кнопку
                    //     startButton.value = 'Start Processing';
                    // });
                });
            } else {
                 console.error("Start form elements not found!");
            }

            // --- Обработчик формы СТОП ---
            if (stopForm && stopButton && startButton) { // Добавил проверки
                stopForm.addEventListener('submit', function(event) {
                    event.preventDefault();

                    stopButton.disabled = true;
                    stopButton.value = 'Stopping...';
                    startButton.disabled = true; // Блокируем и старт на всякий случай

                    fetch("{{ url_for('stop_processing') }}", { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Stop response:', data);
                        fetchStatus(); // Обновляем UI
                    })
                    .catch(error => {
                        console.error('Error stopping processing:', error);
                        alert('Error sending stop signal.');
                        fetchStatus(); // Обновляем UI
                    });
                });
            } else {
                 console.error("Stop form elements not found!");
            }

            // --- Первичный вызов и интервал ---
            fetchStatus(); // Вызываем при загрузке
            setInterval(fetchStatus, 3000); // Запускаем интервал

        }); // Конец DOMContentLoaded

    </script>
</body>
</html>